
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../solvers/">
      
      
        <link rel="next" href="../about/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.28">
    
    
      
        <title>Boundary Conditions - Dyablo-Whole Sun</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6543a935.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="https://unpkg.com/katex@0/dist/katex.min.css">
    
      <link rel="stylesheet" href="../css/custom.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="orange" data-md-color-accent="red">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#boundary-conditions" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Dyablo-Whole Sun" class="md-header__button md-logo" aria-label="Dyablo-Whole Sun" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Dyablo-Whole Sun
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Boundary Conditions
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="orange" data-md-color-accent="red"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="orange" data-md-color-accent="red"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Dyablo-Whole Sun" class="md-nav__button md-logo" aria-label="Dyablo-Whole Sun" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Dyablo-Whole Sun
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../equations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Equations
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../solvers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Solvers
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Boundary Conditions
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Boundary Conditions
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ghost-values" class="md-nav__link">
    <span class="md-ellipsis">
      Ghost values
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flux-override" class="md-nav__link">
    <span class="md-ellipsis">
      Flux override
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Flux override">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hyperbolic-flux" class="md-nav__link">
    <span class="md-ellipsis">
      Hyperbolic flux
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#thermal-flux" class="md-nav__link">
    <span class="md-ellipsis">
      Thermal flux
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#well-balancing" class="md-nav__link">
    <span class="md-ellipsis">
      Well-Balancing
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mhd-boundary-conditions" class="md-nav__link">
    <span class="md-ellipsis">
      MHD Boundary conditions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MHD Boundary conditions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#normal-flux" class="md-nav__link">
    <span class="md-ellipsis">
      Normal flux
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../tests.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tests and validations
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../setups.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setups
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../benchmarks.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Benchmarks
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ghost-values" class="md-nav__link">
    <span class="md-ellipsis">
      Ghost values
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flux-override" class="md-nav__link">
    <span class="md-ellipsis">
      Flux override
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Flux override">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hyperbolic-flux" class="md-nav__link">
    <span class="md-ellipsis">
      Hyperbolic flux
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#thermal-flux" class="md-nav__link">
    <span class="md-ellipsis">
      Thermal flux
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#well-balancing" class="md-nav__link">
    <span class="md-ellipsis">
      Well-Balancing
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mhd-boundary-conditions" class="md-nav__link">
    <span class="md-ellipsis">
      MHD Boundary conditions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MHD Boundary conditions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#normal-flux" class="md-nav__link">
    <span class="md-ellipsis">
      Normal flux
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="boundary-conditions">Boundary Conditions</h1>
<p>The treatment of boundaries in Dyablo can be done in two ways : either by defining <strong>ghost values</strong> outside of the domain or by <strong>overriding the fluxes</strong> for each physical processes. Both methods are not incompatible and can be used together.</p>
<h2 id="ghost-values">Ghost values</h2>
<p>The definition of ghost values is done in the <code>getUserdefBoundaryValue</code> method in <a href="https://drf-gitlab.cea.fr/dyablo/dyablo/-/blob/mdelorme/wholesun/core/src/boundary_conditions/BoundaryConditions.h?ref_type=heads#L184"><code>core/src/boundary_conditions/boundary_conditions.h</code></a>. The method has the following signature:</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="n">ConsState</span><span class="w"> </span><span class="n">getUserdefBoundaryValue</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Uin_t</span><span class="w">               </span><span class="o">&amp;</span><span class="n">Uin</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">                                  </span><span class="k">const</span><span class="w"> </span><span class="n">CellIndex</span><span class="w">           </span><span class="o">&amp;</span><span class="n">iCell_Boundary</span><span class="p">,</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">                                  </span><span class="k">const</span><span class="w"> </span><span class="n">CellIndex</span><span class="w">           </span><span class="o">&amp;</span><span class="n">iCell_Uin</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">                                  </span><span class="k">const</span><span class="w"> </span><span class="n">CellMetaData</span><span class="w">        </span><span class="o">&amp;</span><span class="n">metadata</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">                                  </span><span class="k">const</span><span class="w"> </span><span class="n">CellIndex</span><span class="o">::</span><span class="n">offset_t</span><span class="w"> </span><span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">                                  </span><span class="n">ComponentIndex3D</span><span class="w">           </span><span class="n">dir</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
</span></code></pre></div>
<p>The value returns a conservative state, and takes</p>
<ul>
<li><code>Uin</code> the fields array associated with these variables</li>
<li><code>iCell_Boundary</code> the index of the (virtual) cell outside of the domain we are trying to fill</li>
<li><code>iCell_Uin</code> the index of the reference cell (ie the closest cell in the domain)\</li>
<li><code>metadata</code> an object to query the cell sizes and positions in the mesh</li>
<li><code>offset</code> the offset to apply to <code>iCell_Uin</code> to get <code>iCell_Boundary</code></li>
<li><code>dir</code> the direction along which we got out of the domain (<code>IX</code>, <code>IY</code> or <code>IZ</code>)  </li>
</ul>
<p>This method is used for every physical treatment when using "blocked" solvers.</p>
<h2 id="flux-override">Flux override</h2>
<p>The second method rewrites a given flux at the boundary. It is available for the hyperbolic flux, and for the thermal conduction kernels. No overriding is available yet for the viscous terms as they require cross-directional terms that are more complex to manage this way.</p>
<h3 id="hyperbolic-flux">Hyperbolic flux</h3>
<p>Overriding the <strong>hyperbolic flux</strong> is done in the <code>overrideBoundaryFlux</code> method in <a href="https://drf-gitlab.cea.fr/dyablo/dyablo/-/blob/mdelorme/wholesun/core/src/boundary_conditions/BoundaryConditions.h?ref_type=heads#L228"><code>core/src/boundary_conditions/boundary_conditions.h</code></a>. The method has the following signature:</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="n">ConsState</span><span class="w"> </span><span class="n">overrideBoundaryFlux</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">State</span><span class="o">::</span><span class="n">ConsState</span><span class="w"> </span><span class="n">flux_in</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">                               </span><span class="k">const</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">State</span><span class="o">::</span><span class="n">PrimState</span><span class="w"> </span><span class="n">q</span><span class="p">,</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">                               </span><span class="k">const</span><span class="w"> </span><span class="n">ComponentIndex3D</span><span class="w">          </span><span class="n">dir</span><span class="p">,</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">                               </span><span class="k">const</span><span class="w"> </span><span class="n">real_t</span><span class="w">                    </span><span class="n">ddir</span><span class="p">,</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">                               </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w">                      </span><span class="n">min_bound</span><span class="p">,</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">                                     </span><span class="n">real_t</span><span class="w">                    </span><span class="n">p_out</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
</span></code></pre></div>
<p>The method expects a flux so a conservative variable structure. The function takes the following arguments:</p>
<ul>
<li><code>flux_in</code> the flux returned by the Riemann solver between the value in the cell and the value defined outside of the cell by the <code>getUserdefBoundaryValue</code>.</li>
<li><code>q</code> the cell-centered primitive variables inside the domain</li>
<li><code>dir</code> the direction along which we are trying to define the flux</li>
<li><code>ddir</code> <span class="arithmatex">\(1/\Delta h\)</span> with <span class="arithmatex">\(h\)</span> being the direction given by <code>dir</code></li>
<li><code>min_bound</code> are we on "left" or the "right" of the domain. For instance, if <code>dir==IX</code> then <code>min_bound==true</code> means we're defining a flux at <code>xmin</code> and <code>min_bound==false</code> at <code>xmax</code></li>
<li><code>p_out</code> the pressure at the interface, as recovered from the Riemann solver. </li>
</ul>
<h3 id="thermal-flux">Thermal flux</h3>
<p>For the <strong>thermal flux</strong> at the boundary, we can use the <code>overrideHeatFlux</code> method in <a href="https://drf-gitlab.cea.fr/dyablo/dyablo/-/blob/mdelorme/wholesun/core/src/boundary_conditions/BoundaryConditions.h?ref_type=heads#L253"><code>core/src/boundary_conditions/boundary_conditions.h</code></a></p>
<p>As previously, the method has the following signature:</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="n">real_t</span><span class="w"> </span><span class="n">overrideBoundaryHeatFlux</span><span class="p">(</span><span class="n">real_t</span><span class="w">                          </span><span class="n">flux_in</span><span class="p">,</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">                                </span><span class="k">const</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">State</span><span class="o">::</span><span class="n">PrimState</span><span class="w"> </span><span class="n">q</span><span class="p">,</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">                                </span><span class="k">const</span><span class="w"> </span><span class="n">real_t</span><span class="w">                    </span><span class="n">kappa</span><span class="p">,</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">                                </span><span class="k">const</span><span class="w"> </span><span class="n">real_t</span><span class="w">                    </span><span class="n">dh</span><span class="p">,</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">                                </span><span class="k">const</span><span class="w"> </span><span class="n">ComponentIndex3D</span><span class="w">          </span><span class="n">dir</span><span class="p">,</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">                                </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w">                      </span><span class="n">min_bound</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
</span></code></pre></div>
<p>This time, the method only expects an <strong>energy</strong> flux as return value and not a whole conservative variable array. The method takes the following arguments:</p>
<ul>
<li><code>flux_in</code> the energy flux calculated by the thermal-conduction kernel using the <code>getUserdefBoundaryValue</code>.</li>
<li><code>q</code> the cell-centered primitive variables</li>
<li><code>kappa</code> the value of the thermal diffusion coefficient at the current position</li>
<li><code>dh</code> the cell-size in the current direction</li>
<li><code>dir</code> the current direction</li>
<li><code>min_bound</code> see above.</li>
</ul>
<p>Note that by default, all flux overriding methods return their input flux, so if nothing is done precisely, we use by default the value in the ghost cells.</p>
<h2 id="well-balancing">Well-Balancing</h2>
<p>In the case of a well-balanced run where the boundary conditions require an impenetrable wall in hydrostatic equilibrium, an additional treatment is done, and the fluxes are overriden once-more. The details of the treatment can be found in <a href="https://drf-gitlab.cea.fr/dyablo/dyablo/-/blob/mdelorme/wholesun/core/src/hydro/HydroUpdate_utils.h?ref_type=heads#L572"><code>core/src/hydro/HydroUpdate_utils.h</code></a>.</p>
<p>In this case, the idea is to set the hydro flux to 0 everywhere, except for the moment term in the direction of the boundary. This part of the flux is originally written as : </p>
<div class="arithmatex">\[
F_{\rho u} = \rho u^2 + P
\]</div>
<p>Since we have a wall, <span class="arithmatex">\(u=0\)</span>, but we also wish to find the pressure <span class="arithmatex">\(P\)</span> at the interface, to impose the hydrostatic equilibrium inside the domain. For this, we write the hydrostatic equilibrium :</p>
<div class="arithmatex">\[
\nabla P = \rho g
\]</div>
<p>Discretized as a centered finite-difference, this term can be rewritten as:</p>
<div class="arithmatex">\[
\dfrac{P_R - P_L}{\Delta x} = \rho g
\]</div>
<p>Now, if we are the left boundary, then we know that <span class="arithmatex">\(P_R\)</span> can be retrieved from the Riemann solver (or re-estimated) at the right interface of the cell, and we can find the value of the left pressure which is unknown:</p>
<div class="arithmatex">\[ 
P_L = P_R - \Delta x \rho g
\]</div>
<p>using the centered value of <span class="arithmatex">\(\rho\)</span> for that matter. Hence we redefine the normal momentum part of the flux as this value</p>
<div class="arithmatex">\[
F_{\rho u} = P_L = P_R - \Delta x \rho g
\]</div>
<h2 id="mhd-boundary-conditions">MHD Boundary conditions</h2>
<p>Additionally for MHD fluxes, it is possible to define flux overrides independently of the hydro flux. For the moment, only two fluxes are available: </p>
<ul>
<li><strong>normal-flux</strong> where the tangential field to the interface is null: <span class="arithmatex">\(B_\parallel = 0\)</span>   </li>
<li><strong>perfect-conductor</strong> where the normal field to the interface is null: <span class="arithmatex">\(B_\perp = 0\)</span></li>
</ul>
<p>These two boundary conditions require rewriting the flux correctly which can be tricky.</p>
<h3 id="normal-flux">Normal flux</h3>
<p>In the case of a normal flux for the X interface, we have <span class="arithmatex">\(B_y=B_z=0\)</span>. Because we impose a transparent condition on the flux on <span class="arithmatex">\(B_x\)</span> we have <span class="arithmatex">\(B_{xm}=B_x\)</span> and we can take <span class="arithmatex">\(\psi_m=1/2\psi\)</span> since we usually take <span class="arithmatex">\(\psi=0\)</span> outside of the box. Thus we have: </p>
<div class="arithmatex">\[
\mathbf{F}_{normal\_flux} = \begin{pmatrix}
 \rho u \\
 \rho u^2 + P_{tot} - B_x^2 \\
 \rho uv \\
 \rho uw \\
 (E_{tot}+P_{tot})u - B_x^2u\\ 
 \dfrac{1}{2}\psi \\
 -B_xv \\
 -B_xw \\
 c_h^2 B_x
\end{pmatrix}
\]</div>
<p>Now we need to pay extra attention to the <span class="arithmatex">\(E_{tot}\)</span> and <span class="arithmatex">\(P_{tot}\)</span> terms that have been modified. In this case : </p>
<div class="arithmatex">\[
E_{tot} = \dfrac{1}{2}\rho||\mathbf{u}||^2 + \dfrac{1}{2}B_x^2 + \rho e
\]</div>
<p>and</p>
<div class="arithmatex">\[
P_{tot} = P_{gas} + P_{mag} = P_{gas} + \dfrac{1}{2}B_x^2
\]</div>
<p>In the specific case where we need a <strong>well-balanced MHD run</strong>, then we have the following requirements: </p>
<ul>
<li>Parallel magnetic field is null: <span class="arithmatex">\(B_y = B_z = 0\)</span>.</li>
<li>Normal velocity is null: <span class="arithmatex">\(u=0\)</span>.</li>
<li>Total pressure is reconstructed from HSE: <span class="arithmatex">\(P_{tot} = P_R - \Delta x \rho g_x\)</span></li>
<li>Finally the momentum flux follows: <span class="arithmatex">\(P_{tot} - B_x^2 = P_R - \Delta x \rho g_x - B_x^2\)</span></li>
</ul>
<p>Then the flux is written as follows:</p>
<div class="arithmatex">\[
\mathbf{F}_{NFWB} = \begin{pmatrix}
 0 \\
 P_R - \Delta x \rho g_x - B_x^2 \\
 0 \\
 0 \\
 0\\ 
 \dfrac{1}{2}\psi \\
 -B_xv \\
 -B_xw \\
 c_h^2 B_x
\end{pmatrix}
 \]</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
        <script src="../javascripts/katex.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/katex.min.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/contrib/auto-render.min.js"></script>
      
    
  </body>
</html>